<!DOCTYPE html>
<html>
  <head>
    <title>Bus Stops Map</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"
    />
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"
    />
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <h2>Bus Stops in Kathmandu</h2>
    <div id="map"></div>
    <button id="resetButton">Clear Route</button>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

    <script>
      const map = L.map("map").setView([27.7, 85.3], 13);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: "Â© OpenStreetMap contributors",
      }).addTo(map);

      const markerCluster = L.markerClusterGroup();
      let selectedStops = [];
      let routeLayer;
      let predefinedRoutes = [];

      // Load predefined routes
      fetch("bus_routes.json")
        .then((res) => res.json())
        .then((routes) => {
          predefinedRoutes = routes;

          // Extract all unique stops for markers
          const allStops = [];
          const stopSet = new Set();
          routes.forEach((route) => {
            route.stops.forEach((stop) => {
              const key = `${stop.lat},${stop.lon}`;
              if (!stopSet.has(key)) {
                stopSet.add(key);
                allStops.push(stop);
              }
            });
          });

          // Add markers for all stops
          allStops.forEach((stop) => {
            const marker = L.marker([stop.lat, stop.lon]).bindPopup(
              `<strong>${stop.name}</strong>`
            );
            marker.on("click", () => {
              if (
                !selectedStops.some(
                  (s) => s.lat === stop.lat && s.lon === stop.lon
                )
              ) {
                selectedStops.push(stop);
                marker.openPopup();
                updateRoute();
              }
            });
            markerCluster.addLayer(marker);
          });

          map.addLayer(markerCluster);
        });

      function updateRoute() {
        if (selectedStops.length === 2) {
          const [start, end] = selectedStops;
          const routeStops = findRouteSubset(start, end);
          drawRoute(routeStops);
        }
      }

      function findRouteSubset(start, end) {
        // Find a predefined route containing both start and end stops
        for (const route of predefinedRoutes) {
          const stops = route.stops;
          const startIndex = stops.findIndex(
            (s) => s.lat === start.lat && s.lon === start.lon
          );
          const endIndex = stops.findIndex(
            (s) => s.lat === end.lat && s.lon === end.lon
          );

          if (startIndex !== -1 && endIndex !== -1 && startIndex <= endIndex) {
            // Return the subset of stops from start to end
            return stops.slice(startIndex, endIndex + 1);
          }
        }

        // Fallback: direct route if no predefined route found
        return [start, end];
      }

      function resetRoute() {
        selectedStops = [];
        if (routeLayer) {
          map.removeLayer(routeLayer);
          routeLayer = null;
        }
      }

      async function drawRoute(stops) {
        const routeCoords = await fetchRouteFromAPI(stops);
        if (routeCoords.length === 0) {
          alert(
            "Unable to fetch route. Please check your API key or try again."
          );
          return;
        }

        if (routeLayer) {
          map.removeLayer(routeLayer);
        }

        routeLayer = L.polyline(routeCoords, { color: "blue" }).addTo(map);
        map.fitBounds(routeLayer.getBounds());
      }

      async function fetchRouteFromAPI(stops) {
        const url =
          "https://api.openrouteservice.org/v2/directions/driving-car/geojson";
        try {
          const res = await fetch(url, {
            method: "POST",
            headers: {
              Authorization: "API_KEY", // Replace with a valid key
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              coordinates: stops.map((stop) => [stop.lon, stop.lat]),
            }),
          });

          if (!res.ok) throw new Error(`API error: ${res.status}`);
          const data = await res.json();
          return data.features[0].geometry.coordinates.map(([lon, lat]) => [
            lat,
            lon,
          ]);
        } catch (err) {
          console.error("Error fetching route:", err);
          return [];
        }
      }

      document
        .getElementById("resetButton")
        ?.addEventListener("click", resetRoute);
    </script>
  </body>
</html>
